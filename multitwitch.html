<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Wow Much Twitch</title>
    <script type="text/javascript">var _gaq = _gaq || []; _gaq.push(['_setAccount', 'UA-13099891-1']); _gaq.push(['_trackPageview']); (function () { var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true; ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js'; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s); })();</script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
    <link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">

    <style>
        body {
            background: black;
            color: white;
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            padding: 0;
            margin: 0;
        }

        .frames {
            width: 86%;
            height: 100%;
            float: left;
            position: absolute;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

            .frames > iframe {
                display: inline-block;
                position: relative;
            }

            .frames .frame {
                display: inline-block;
                position: relative;
                cursor: move;
                background: #313;
                box-sizing: border-box;
                padding: 0px;
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -khtml-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }

                .frames .frame iframe {
                    width: 100%;
                    height: 100%;
                    box-sizing: border-box;
                    margin: auto;
                }

        .expandbutton {
            position: fixed;
            top: 7px;
            right: 0;
            cursor: pointer;
            font-size: 20px;
            z-index: 100002;
            color: gray;
        }

        .rightpane {
            float: right;
            width: 14%;
            height: 110%;
            display: block;
            padding: 1em;
            padding-bottom: 5em;
            box-sizing: border-box;
            z-index: 100001;
            position: relative;
            background: #111;
            overflow-y: auto;
        }

        .recentstream {
            cursor: pointer;
        }

        .layout {
            cursor: pointer;
        }
    </style>
</head>
<body onload="OnBodyLoad();" class='theme-dark homepage'>

    <span class="expandbutton"><i class="icon-fixed-width icon-arrow-right"></i></span>
    <div class="rightpane">
        <br /><div><input class="addstreaminput" placeholder="Add Stream" /></div><div class="recentstreams"><h2>Recent Streams</h2></div>
        <div class="layouts">
            <h2>Layouts</h2>
            <div class="layout">Tile</div>
            <div class="soonlayout">Big View (coming soon)</div>
            <div class="soonlayout">Custom (coming soon)</div>
        </div>
        <h2>Zoom</h2><div class="or"><input type="range" class="overlaprange" min="0" max="60" value="0" /></div>
        <br /><br /><div>todo: saving preferences, big view, chat in the right pane, combined chat view, custom layout mode, closing streams, stream list in url, rearranging stream order, cross-tab functionality, autocomplete on adding streams</div>
    </div>
    <div class="frames"></div>
</body>

</html>

<script type="text/javascript">

    class BaseLayout {
        constructor() {
            this.name = 'BaseLayout';
            this.isDragging = false;
            this.isSizingX = false;
            this.isSizingY = false;
            this.draggingElement = null;
            this.startDragX = 0;
            this.startDragY = 0;
            this.overlappercent = 0;
            this.views = [];
        }

        AddFrame(url, frame) {
            var self = this;

            console.log('adding frame ' + url);
            self.views.push({ url: url });

            frame.css({ 'z-index': (10000 - self.views.length) }).attr('data-priority', self.views.length - 1);
            $('.frames').append(frame);

            $(".frames .frame").off('mousedown mousemove mouseup mouseover mouseout');
            $('.frames').off('mousemove');
            $('.frames').mousemove(function (e) {
                if (self.isDragging == false) return;
                if (!self.draggingElement) {
                    self.isDragging = false;
                    return;
                }
                if (this != self.draggingElement) {
                    $(self.draggingElement).find('iframe').css('width', '');
                    $(self.draggingElement).find('iframe').css('height', '');
                    self.isDragging = false;
                    return;
                }
            });

            $(".frames .frame")
                .mouseover(function (e) {
                    $(this).css('padding', '50px');
                    $(this).find('iframe').css('padding', '50px');
                    $(this).css('z-index', '10000');
                })
                .mouseout(function (e) {
                    $(this).css('padding', '');
                    $(this).find('iframe').css('padding', '');
                    $(this).css('z-index', 10000 - 1 - parseInt($(this).attr('data-priority')));

                    if (self.isDragging) {
                        self.isDragging = false;
                        self.draggingElement = null;
                        e.stopPropagation();
                    }
                });


            $(".frames .frame")
                .mousedown(function (e) {
                    self.isDragging = true;

                    var position = $(this).offset();
                    var w = $(this).width();
                    var h = $(this).height();

                    self.startDragX = e.pageX - (position.left);
                    self.startDragY = e.pageY - (position.top);

                    self.draggingElement = this;

                    $(this).css('position', 'absolute');

                    var x = e.pageX - self.startDragX;
                    var y = e.pageY - self.startDragY;
                    $(this).css('top', y);
                    $(this).css('left', x);
                    e.stopPropagation();
                })
                .mousemove(function (e) {
                    if (self.isDragging == false) return;
                    if (!self.draggingElement) {
                        self.isDragging = false;
                        return;
                    }
                    if (this != self.draggingElement) {
                        self.isDragging = false;
                        return;
                    }
                    e.stopPropagation();

                    var w = $(this).width();
                    var h = $(this).height();

                    var x = e.pageX - self.startDragX;
                    var y = e.pageY - self.startDragY;
                    $(this).css('top', y);
                    $(this).css('left', x);
                })
                .mouseup(function (e) {
                    var wasDragging = self.isDragging;
                    self.isDragging = false;
                    if (wasDragging) {
                        var x = e.pageX - self.startDragX;
                        var y = e.pageY - self.startDragY;
                        $(this).css('top', y);
                        $(this).css('left', x);

                        self.draggingElement = null;
                        e.stopPropagation();
                    }
                });
        }

        LayoutFrame(el, frames, width, height, counter, cols, rows, w, h) {
            el.css('position', 'absolute');
            el.css('width', width + 'px');
            el.css('height', height + 'px');
            var x = counter % cols;
            var y = Math.floor(counter / cols);
            x *= w / cols;
            y *= h / rows;

            x -= (width * 0.2) * (this.overlappercent / 100);
            y -= (height * 0.1) * (this.overlappercent / 100);
            if (frames.length == 2 && rows == 1 && cols == 2 && parseInt(el.attr('data-priority')) % 2 == 1) {
                y = h - height;
                x = w - width;
            } else if (frames.length == 2 && rows == 2 && cols == 1 && parseInt(el.attr('data-priority')) % 2 == 1) {
                x += (w - width) + (width * 0.4) * (this.overlappercent / 100);
                y -= (height * 0.5) * (this.overlappercent / 100);
            } else if (frames.length == 2) {
            } else {
            }

            el.css('left', x + 'px');
            el.css('top', y + 'px');
        };

        ApplyLayout() {
            var frames = $('.frames .frame');
            if (frames.length == 0) return;
            var div = Math.sqrt(frames.length);
            var width = 100 / Math.ceil(div);
            var height = 100 / Math.ceil(div);
            var h = $('.frames').height();
            h = $(window).height();
            var w = $('.frames').width();

            var counter = 0;
            var rows = Math.ceil(div);
            var cols = Math.ceil(div);
            if (1 || w / h > 1.8 || w / h < 1.7) {
                rows = div * (16 / 9) / (w / h);
                cols = div * (9 / 16) / (h / w);
                var r = rows;
                var c = cols;
                rows = Math.round(rows);
                cols = Math.round(cols);
                if (c < r) {
                    while (frames.length > (cols) * rows) {
                        cols++;
                    }
                } else {
                    while (frames.length > (rows) * cols) {
                        rows++;
                    }
                }
            }
            while (frames.length <= (rows - 1) * cols) {
                rows--;
            }
            while (frames.length <= (cols - 1) * rows) {
                cols--;
            }

            width = w / cols;
            height = h / rows;
            width *= (100 + this.overlappercent) / 100;
            height *= (100 + this.overlappercent) / 100;
            height = Math.min(height, width * (9 / 16));
            width = Math.min(width, height * (16 / 9));

            var self = this;
            frames.each(function () {
                self.LayoutFrame($(this), frames, width, height, counter, cols, rows, w, h);
                counter++;
            });
        };
    }

    var recents = {};
    var layout;// = new BaseLayout();

    function ApplyLayout() {
        console.log('applying layout');
        if (layout && layout.ApplyLayout) {
            layout.ApplyLayout();
        } else {
            console.log('unknown layout ' + layout + '!');
        }
    }

    function AddFrame(url) {
        var m = url.match(/twitch\.tv\/(.+)/);
        if (m && m.length == 2) {
            url = m[1];
        }

        var lasttime = (new Date()).getTime();
        recents[url.toLowerCase()] = { url: url, lasttime: lasttime };
        CheckRecents(true);

        var frame = $('<div class="frame"><iframe src="https://player.twitch.tv/?channel='
            + url + '&volume=0.00&muted" frameborder="0" scrolling="no" allowfullscreen ></iframe></div>');

        layout.AddFrame(url, frame);
        ApplyLayout();
    }

    function CheckRecents(force) {
        var storedrecents = localStorage.getItem("recents");
        if (!storedrecents || storedrecents == '') {
            storedrecents = '[]';
        }
        var defaults = [{ url: "morgalor", lasttime: "1" }, { url: "GamesDoneQuick", lasttime: "1" }, { url: "MegaBlast98", lasttime: "1" }, { url: "ESL_SC2", lasttime: "1" }, { url: "ESL_Overwatch", lasttime: "1" },
        { url: "cheese05", lasttime: "1" }, { url: "RetroGamingLiveTV", lasttime: "1" }, { url: "GOGcom", lasttime: "1" }, { url: "360Chrism", lasttime: "1" }, { url: "SpikeVegeta", lasttime: "1" },
        { url: "BaseTradeTV", lasttime: "1" }, { url: "ByunPrime", lasttime: "1" }];
        storedrecents = $.parseJSON(storedrecents);
        storedrecents = [].concat(defaults, storedrecents);
        console.log(storedrecents);
        var change = false;
        for (var i = 0; i < storedrecents.length; i++) {
            var sr = storedrecents[i];
            if (recents.hasOwnProperty(sr.url.toLowerCase())) {
                if (sr.lasttime > recents[sr.url.toLowerCase()].lasttime) {
                    recents[sr.url.toLowerCase()].lasttime = sr.lasttime;
                    change = true;
                }
            } else {
                recents[sr.url.toLowerCase()] = sr;
                change = true;
            }
        }

        if (force) change = true;
        if (change == false) return;

        var recents_a = [];
        for (var r in recents) {
            if (r != r.toLowerCase()) {
                delete recents[r];
                continue;
            }
            recents_a.push(recents[r]);
        }

        recents_a.sort(function (a, b) { return parseInt(b.lasttime) - parseInt(a.lasttime); });
        while (recents_a.length > 15) recents_a.pop();
        localStorage.setItem("recents", JSON.stringify(recents_a));

        $('.recentstreams').html('');
        for (var i = 0; i < recents_a.length; i++) {
            $('.recentstreams').append('<div class="recentstream">' + recents_a[i].url + '</div>');
        }
        $('.recentstream').click(function () { AddFrame($(this).text()); });
    }

    function OnBodyLoad() {
        if (typeof (Storage) !== "undefined") {
            var layoutname = localStorage.getItem("layout");
            if (!layoutname || layoutname == '') layout = new BaseLayout();
        }
        CheckRecents(true);
        setInterval(function () { CheckRecents() }, 10000);

        $(window).on('resize', function () {
            ApplyLayout();
        });
        $('.expandbutton').click(function () {
            if ($('.rightpane').css('display') == 'none') {
                $('.rightpane').css('display', 'block');
                $('.frames').css('width', '86%');
                $('.expandbutton i').attr('class', 'icon-fixed-width icon-arrow-right');
            } else {
                $('.rightpane').css('display', 'none');
                $('.frames').css('width', '100%');
                $('.expandbutton i').attr('class', 'icon-fixed-width icon-arrow-left');
            }
            ApplyLayout();
        });
        $('.frames').html('');
        ApplyLayout();

        $('.layout').click(function () {
            var layoutname = $(this).text().toLowerCase();
            ApplyLayout();
        });

        $('.addstreaminput').submit(function () { AddFrame($(this).val()); });
        $('.addstreaminput').keyup(function (e) {
            if (e.keyCode == 13) {
                AddFrame($(this).val());
                $(this).val('');
            }
        });

        $('input.overlaprange').val(layout.overlappercent);

        $('input.overlaprange').change(function () {
            layout.overlappercent = parseInt($(this).val());
            console.log('overlappercent == ' + layout.overlappercent + '%');
            ApplyLayout();
        });
    }

</script>
